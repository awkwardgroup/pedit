var PEDIT=PEDIT||{};PEDIT={mouseStartX:0,mouseStartY:0,mouseEndX:0,mouseEndY:0,isTouchDevice:!1,init:function(a){var b=document.getElementById(a);return this.isTouchDevice=PEDIT.tools.isTouchDevice(),new PEDIT.Editor(b)},Editor:function(a){function b(a){var b=new PEDIT.Child(c,a,c.childTrailID);return c.children[c.childTrailID]=b,a.setAttribute("data-child-id",c.childTrailID),c.childTrailID++,b}var c=this;c.element=a,c.width=a.offsetWidth,c.height=a.offsetHeight,c.offset=0,c.remove=!0,c.resize=!0,c.percent=!0,c.updateChildMaxSize=!0,c.childMaxWidth=0,c.childMaxHeight=0,c.childMinWidth=10,c.childMinHeight=10,c.childTrailID=1,c.moveDoneFunction=null,c.resizeDoneFunction=null,c.removeDoneFunction=null,c.children=[],PEDIT.events.mouseDown(c.element,function(a){a=a||window.event;var b=PEDIT.tools.getPageXY(a);PEDIT.mouseStartX=b[0],PEDIT.mouseStartY=b[1],PEDIT.mouseEndX=b[0],PEDIT.mouseEndY=b[1],c.width=c.element.offsetWidth,c.height=c.element.offsetHeight,c.updateChildMaxSize&&(c.childMaxWidth=100,c.childMaxHeight=100)}),c.render=function(){for(var a=c.element.children,b=[],d=0,e=a.length;e>d;d++)a[d].getAttribute("data-child-id")||b.push(a[d]);for(d=0;d<b.length;d++)c.addChild(b[d])},c.addChild=function(a){if(images=a.getElementsByTagName("img"),"undefined"==typeof images[0])return b(a);var c=setInterval(function(){return images[0].complete?(clearInterval(c),b(a)):void 0},10)},c.calculateSize=function(a,b){var d=a/(c.width-c.offset)*100;return b||(d=a/(c.height-c.offset)*100),d}},Child:function(a,b,c){var d=this;d.id=c,d.element=b,d.elementResize=null,d.elementRemove=null,d.editor=a,d.width=a.calculateSize(b.offsetWidth,!0),d.height=a.calculateSize(b.offsetHeight,!1),d.offsetX=a.calculateSize(b.offsetLeft,!0),d.offsetY=a.calculateSize(b.offsetTop,!1),d.locked=!1,d.editor.resize&&(d.elementResize=document.createElement("div"),d.elementResize.className="resize",d.element.appendChild(d.elementResize)),d.editor.remove&&(d.elementRemove=document.createElement("div"),d.elementRemove.className="remove",d.element.appendChild(d.elementRemove)),d.element.style.width=d.width+"%",d.element.style.height=d.height+"%",console.log(d.width,d.height),PEDIT.events.mouseDown(d.element,function(){d.updateOffsetLimits(),d.move()}),d.elementResize&&PEDIT.events.mouseDown(d.elementResize,function(){d.locked=!0,d.resize()}),d.elementRemove&&PEDIT.events.mouseDown(d.elementRemove,function(a){a=a||window.event,PEDIT.isTouchDevice&&a.preventDefault(),d.locked=!0,PEDIT.events.mouseUp(d.elementRemove,function(){d.remove()}),PEDIT.events.mouseUp(document,function(){d.locked=!1})}),d.updateOffsetLimits=function(){d.offsetLimitX=100-d.width,d.offsetLimitY=100-d.height},d.move=function(){var b=d.offsetX,c=d.offsetY;if(!d.locked){var e=function(e){e=e||window.event,PEDIT.isTouchDevice&&e.preventDefault();var f=PEDIT.tools.getPageXY(e);PEDIT.mouseEndX=f[0],PEDIT.mouseEndY=f[1],b=d.offsetX+a.calculateSize(PEDIT.mouseEndX-PEDIT.mouseStartX,!0),b=0>b?0:b,b=b>d.offsetLimitX?d.offsetLimitX:b,d.element.style.left=b+"%",c=d.offsetY+a.calculateSize(PEDIT.mouseEndY-PEDIT.mouseStartY,!1),c=0>c?0:c,c=c>d.offsetLimitY?d.offsetLimitY:c,d.element.style.top=c+"%"};PEDIT.events.mouseMove(document,e);var f=function(){PEDIT.events.mouseMove(document,e,!0),PEDIT.events.mouseUp(document,f,!0),d.offsetX=b,d.offsetY=c,"function"==typeof a.moveDoneFunction&&a.moveDoneFunction(d)};PEDIT.events.mouseUp(document,f)}},d.resize=function(){var b=function(b){b=b||window.event,PEDIT.isTouchDevice&&b.preventDefault();var c=PEDIT.tools.getPageXY(b);PEDIT.mouseStartX=c[0],PEDIT.mouseStartY=c[1];var e=d.height/d.width,f=PEDIT.mouseStartX-PEDIT.mouseEndX,g=f*f,h=PEDIT.mouseStartY-PEDIT.mouseEndY,i=h*h,j=1.5*Math.sqrt(g+i);j=f>=0&&h>=0?j:-j;var k=d.width+a.calculateSize(j,!0),l=e*k;d.updateElementSize(k,l),PEDIT.mouseEndX=c[0],PEDIT.mouseEndY=c[1]};PEDIT.events.mouseMove(document,b);var c=function(){PEDIT.events.mouseMove(document,b,!0),PEDIT.events.mouseUp(document,c,!0),d.locked=!1,"function"==typeof a.resizeDoneFunction&&a.resizeDoneFunction(d)};PEDIT.events.mouseUp(document,c)},d.updateElementSize=function(a,b){if(!(a>d.editor.childMaxWidth||a<d.editor.childMinWidth||b>d.editor.childMaxHeight||b<d.editor.childMinHeight)){var c=a-d.width,e=b-d.height;c>0?(d.width=a>99?100:a,d.height=b>99?100:b):(d.width=a,d.height=b),d.updateOffsetLimits(),d.element.style.width=d.width+"%",d.element.style.height=d.height+"%";var f=d.offsetX-c/2,g=d.offsetY-e/2;d.updateElementPosition(f,g)}},d.updateElementPosition=function(a,b){a=0>a?0:a>d.offsetLimitX?d.offsetLimitX:a,b=0>b?0:b>d.offsetLimitY?d.offsetLimitY:b,d.element.style.left=a+"%",d.element.style.top=b+"%",d.offsetX=a,d.offsetY=b},d.remove=function(){d.editor.element.removeChild(d.element),d.editor.children.splice(d.id,1),"function"==typeof a.removeDoneFunction&&a.removeDoneFunction(d)}}},PEDIT.events={mouseDown:function(a,b,c){this.bindEvent("down",a,b,c)},mouseUp:function(a,b,c){this.bindEvent("up",a,b,c)},mouseMove:function(a,b,c){this.bindEvent("move",a,b,c)},bindEvent:function(a,b,c,d){PEDIT.isTouchDevice?"down"===a?d?b.removeEventListener("touchstart",c,!1):b.addEventListener("touchstart",c,!1):"up"===a?d?b.removeEventListener("touchend",c,!1):b.addEventListener("touchend",c,!1):"move"===a&&(d?b.removeEventListener("touchmove",c,!1):b.addEventListener("touchmove",c,!1)):"down"===a?b.onmousedown=d?null:c:"up"===a?b.onmouseup=d?null:c:"move"===a&&(b.onmousemove=d?null:c)}},PEDIT.tools={isTouchDevice:function(){try{return document.createEvent("TouchEvent"),!0}catch(a){return!1}},getPageXY:function(a){return"undefined"!=typeof a.touches?[a.touches[0].pageX,a.touches[0].pageY]:[a.x,a.y]},addTouchClass:function(a){var b=(" "+document.body.className+" ").indexOf(" "+a+" ")>-1;!b&&PEDIT.isTouchDevice&&(document.body.className+=""!==document.body.className?" "+a:a)},console:function(a,b){var c=document.getElementById("debug").innerHTML;c=b?a+"<br>"+c:a,document.getElementById("debug").innerHTML=c}};